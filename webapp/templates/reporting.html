{% extends 'base.html' %}

{% block title %}Reporting{% endblock %}

{% block header %}Reporting{% endblock %}

{% block content %}
  <div class="card">
    <h3>Runs</h3>
    <ul id="runs-list">
      {% for r in runs %}
        <li>
          <a href="/runs/{{ r }}/report.html">{{ r }}</a>
          <button class="delete-run" data-run="{{ r }}" title="Delete run" style="border:none;background:transparent;cursor:pointer;color:#c00;margin-left:8px;">üóëÔ∏è</button>
          <a href="/runs/{{ r }}/report.html" target="_blank" title="Open in new tab" style="margin-left:6px;color:#666;text-decoration:none;">üîó</a>
        </li>
      {% else %}
        <li>No runs</li>
      {% endfor %}
    </ul>
  </div>

  <style>
    /* full-screen report overlay */
    .report-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;align-items:stretch;}
    .report-overlay .container{position:relative;flex:1;display:flex;flex-direction:column;background:#fff;margin:2vh 2vw;border-radius:6px;overflow:hidden}
    .report-overlay .toolbar{background:#f5f5f5;padding:8px 12px;display:flex;align-items:center;justify-content:space-between}
    .report-overlay .toolbar .title{font-weight:600;color:#333}
    .report-overlay .toolbar .controls button{border:0;background:transparent;font-size:18px;cursor:pointer}
    .report-overlay iframe{flex:1;border:0;width:100%;height:calc(100vh - 48px)}
  </style>

  <div id="report-overlay" class="report-overlay">
    <div class="container">
      <div class="toolbar">
        <div class="title" id="overlay-title">Report</div>
        <div class="controls">
          <button id="overlay-back" title="Back">‚óÄ</button>
          <button id="overlay-forward" title="Forward">‚ñ∂</button>
          <button id="overlay-open-new" title="Open in new tab">üîó</button>
          <button id="overlay-close" title="Close">‚úñ</button>
        </div>
      </div>
  <iframe id="overlay-frame" src="about:blank" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
    </div>
  </div>

  <script>
    // Handle delete clicks and overlay behavior
    document.addEventListener('click', function(ev){
      var del = ev.target.closest && ev.target.closest('.delete-run')
      if(del){
        ev.preventDefault();
        var run = del.getAttribute('data-run')
        if(!confirm('Delete run "' + run + '"? This cannot be undone.')) return;
        fetch('/reporting/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({run: run})})
          .then(r => { if(!r.ok) throw new Error('delete failed'); return r.json() })
          .then(j => { if(j.ok){ var li = del.parentElement; li.parentElement.removeChild(li); } else { alert('Delete failed'); } })
          .catch(e => { alert('Delete failed: ' + e); })
        return;
      }

      // run link clicked -> open overlay instead of navigating (unless explicitly target _blank)
      var link = ev.target.closest && ev.target.closest('a[href]')
      if(!link) return;
      var href = link.getAttribute('href')
      // only intercept internal run report links
      if(!href || !href.startsWith('/runs/') ) return;
      if(link.getAttribute('target') === '_blank') return; // allow explicit new-tab links
      // prevent navigation and open overlay
      ev.preventDefault();
      var overlay = document.getElementById('report-overlay');
      var frame = document.getElementById('overlay-frame');
      var title = document.getElementById('overlay-title');
      title.textContent = link.textContent || 'Report';
      frame.src = href;
      overlay.style.display = 'flex';
      // set open-new button behaviour
      var btnNew = document.getElementById('overlay-open-new');
      btnNew.onclick = function(){ window.open(href, '_blank') }
      // focus handling
      document.getElementById('overlay-close').focus()
    })

      // close overlay
    document.getElementById('overlay-close').addEventListener('click', function(){
      var overlay = document.getElementById('report-overlay');
      var frame = document.getElementById('overlay-frame');
      frame.src = 'about:blank';
      overlay.style.display = 'none';
    })

    // back/forward buttons
    function iframeHistoryCall(fn){
      try{
        var frame = document.getElementById('overlay-frame');
        if(frame && frame.contentWindow){ fn(frame.contentWindow); }
      }catch(e){
        console.warn('iframe history call failed', e)
      }
    }
    document.getElementById('overlay-back').addEventListener('click', function(){ iframeHistoryCall(function(w){ try{ w.history.back(); }catch(e){}}) })
    document.getElementById('overlay-forward').addEventListener('click', function(){ iframeHistoryCall(function(w){ try{ w.history.forward(); }catch(e){}}) })

    // ESC closes overlay
    document.addEventListener('keydown', function(ev){
      if(ev.key === 'Escape'){
        var overlay = document.getElementById('report-overlay');
        if(overlay && overlay.style.display === 'flex'){
          document.getElementById('overlay-close').click();
        }
      }
    })
  </script>
{% endblock %}
